\hypertarget{misc_8py}{\section{misc.\-py}
\label{misc_8py}\index{pyneb/utils/misc.\-py@{pyneb/utils/misc.\-py}}
}

\begin{DoxyCode}
\hypertarget{misc_8py_source_l00001}{}\hyperlink{namespacepyneb_1_1utils_1_1misc}{00001} \textcolor{keyword}{import} numpy \textcolor{keyword}{as} np
00002 \textcolor{keyword}{import} os
00003 \textcolor{keyword}{import} sys
00004 \textcolor{keyword}{import} traceback
00005 \textcolor{keyword}{import} pyneb \textcolor{keyword}{as} pn
00006 
00007 \textcolor{comment}{#from scipy.linalg import solve as solve\_sc}
00008 \textcolor{keyword}{from} numpy.linalg \textcolor{keyword}{import} solve \textcolor{keyword}{as} solve\_np
00009 
00010 
00011 \textcolor{keywordflow}{try}:
00012     \textcolor{keyword}{import} cvxopt
\hypertarget{misc_8py_source_l00013}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ac06a00191494a0f2d86df407a02b358a}{00013}     cvxopt\_ok = \textcolor{keyword}{True}
00014     
00015 \textcolor{keywordflow}{except}:
00016     cvxopt\_ok = \textcolor{keyword}{False}
00017 
00018 \textcolor{stringliteral}{"""}
00019 \textcolor{stringliteral}{from scipy.sparse.linalg import spsolve as solve\_sp}
00020 \textcolor{stringliteral}{}
00021 \textcolor{stringliteral}{try:}
00022 \textcolor{stringliteral}{    from numba import double}
00023 \textcolor{stringliteral}{    from numba.decorators import jit, autojit}
00024 \textcolor{stringliteral}{except:}
00025 \textcolor{stringliteral}{    pass}
00026 \textcolor{stringliteral}{}
00027 \textcolor{stringliteral}{}
00028 \textcolor{stringliteral}{try:}
00029 \textcolor{stringliteral}{    import rpy2.robjects.numpy2ri}
00030 \textcolor{stringliteral}{    from rpy2.robjects.packages import importr}
00031 \textcolor{stringliteral}{    rpy2.robjects.numpy2ri.activate()}
00032 \textcolor{stringliteral}{    base     = importr('base')}
00033 \textcolor{stringliteral}{    rpy\_ok = True}
00034 \textcolor{stringliteral}{except:}
00035 \textcolor{stringliteral}{    rpy\_ok = False}
00036 \textcolor{stringliteral}{"""}
00037     
00038 
00039 \textcolor{keywordflow}{if} sys.version\_info.major < 3:
\hypertarget{misc_8py_source_l00040}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ac280e2da31c4a00379cb0b5852ad0d8e}{00040}     \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ac280e2da31c4a00379cb0b5852ad0d8e}{bs}(x):
00041         \textcolor{keywordflow}{return} x
00042 \textcolor{keywordflow}{else}:
00043     \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ac280e2da31c4a00379cb0b5852ad0d8e}{bs}(x):
00044         \textcolor{keywordflow}{if} type(x) \textcolor{keywordflow}{is} bytes \textcolor{keywordflow}{or} type(x) \textcolor{keywordflow}{is} np.bytes\_:
00045             \textcolor{keywordflow}{return} x.decode(encoding=\textcolor{stringliteral}{'UTF-8'})
00046         \textcolor{keywordflow}{elif} type(x) \textcolor{keywordflow}{is} str \textcolor{keywordflow}{or} type(x) \textcolor{keywordflow}{is} np.str\_:
00047             \textcolor{keywordflow}{return} x.encode(encoding=\textcolor{stringliteral}{'UTF-8'})
00048             
\hypertarget{misc_8py_source_l00049}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a937fc19e910346d9d288992e8eeab0ea}{00049} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a937fc19e910346d9d288992e8eeab0ea}{execution\_path}(filename):
00050     \textcolor{keywordflow}{return} os.path.join(os.path.dirname(sys.\_getframe(1).f\_code.co\_filename), filename)
00051 
\hypertarget{misc_8py_source_l00052}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a7adb0042ec7ea039b5a94fd243a596f1}{00052} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a7adb0042ec7ea039b5a94fd243a596f1}{\_returnNone}(*argv, **kwargs):
00053     \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00054 
\hypertarget{misc_8py_source_l00055}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a7a4c4b4ba1c884da72e0ea05aa8fb90b}{00055} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a7a4c4b4ba1c884da72e0ea05aa8fb90b}{int\_to\_roman}(input\_):
00056     \textcolor{stringliteral}{"""}
00057 \textcolor{stringliteral}{    Convert an integer to Roman numerals.}
00058 \textcolor{stringliteral}{    }
00059 \textcolor{stringliteral}{    Examples:}
00060 \textcolor{stringliteral}{    >>> int\_to\_roman(0)}
00061 \textcolor{stringliteral}{    Traceback (most recent call last):}
00062 \textcolor{stringliteral}{    ValueError: Argument must be between 1 and 3999}
00063 \textcolor{stringliteral}{    }
00064 \textcolor{stringliteral}{    >>> int\_to\_roman(-1)}
00065 \textcolor{stringliteral}{    Traceback (most recent call last):}
00066 \textcolor{stringliteral}{    ValueError: Argument must be between 1 and 3999}
00067 \textcolor{stringliteral}{    }
00068 \textcolor{stringliteral}{    >>> int\_to\_roman(1.5)}
00069 \textcolor{stringliteral}{    Traceback (most recent call last):}
00070 \textcolor{stringliteral}{    TypeError: expected integer, got <type 'float'>}
00071 \textcolor{stringliteral}{    }
00072 \textcolor{stringliteral}{    >>> print int\_to\_roman(2000)}
00073 \textcolor{stringliteral}{    MM}
00074 \textcolor{stringliteral}{}
00075 \textcolor{stringliteral}{    >>> print int\_to\_roman(1999)}
00076 \textcolor{stringliteral}{    MCMXCIX}
00077 \textcolor{stringliteral}{}
00078 \textcolor{stringliteral}{    """}
00079     \textcolor{keywordflow}{if} type(input\_) != type(1):
00080         \textcolor{comment}{#raise TypeError, "expected integer, got %s" % type(input\_)}
00081         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00082     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} 0 < input\_ < 4000:
00083         \textcolor{comment}{#raise ValueError, "Argument must be between 1 and 3999"}
00084         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00085     ints = (1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1)
00086     nums = (\textcolor{stringliteral}{'M'}, \textcolor{stringliteral}{'CM'}, \textcolor{stringliteral}{'D'}, \textcolor{stringliteral}{'CD'}, \textcolor{stringliteral}{'C'}, \textcolor{stringliteral}{'XC'}, \textcolor{stringliteral}{'L'}, \textcolor{stringliteral}{'XL'}, \textcolor{stringliteral}{'X'}, \textcolor{stringliteral}{'IX'}, \textcolor{stringliteral}{'V'}, \textcolor{stringliteral}{'IV'}, \textcolor{stringliteral}{'I'})
00087     result = \textcolor{stringliteral}{""}
00088     \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(ints)):
00089         count = int(input\_ / ints[i])
00090         result += nums[i] * count
00091         input\_ -= ints[i] * count
00092     \textcolor{keywordflow}{return} result
00093 
00094 
\hypertarget{misc_8py_source_l00095}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ae67dbd6bb48d64216bc162ebdc25a183}{00095} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ae67dbd6bb48d64216bc162ebdc25a183}{roman\_to\_int}(input\_):
00096     \textcolor{stringliteral}{"""}
00097 \textcolor{stringliteral}{    Convert a roman numeral to an integer.}
00098 \textcolor{stringliteral}{    }
00099 \textcolor{stringliteral}{    >>> r = range(1, 4000)}
00100 \textcolor{stringliteral}{    >>> nums = [int\_to\_roman(i) for i in r]}
00101 \textcolor{stringliteral}{    >>> ints = [roman\_to\_int(n) for n in nums]}
00102 \textcolor{stringliteral}{    >>> print r == ints}
00103 \textcolor{stringliteral}{    1}
00104 \textcolor{stringliteral}{    }
00105 \textcolor{stringliteral}{    >>> roman\_to\_int('VVVIV')}
00106 \textcolor{stringliteral}{    Traceback (most recent call last):}
00107 \textcolor{stringliteral}{     ...}
00108 \textcolor{stringliteral}{    ValueError: input is not a valid roman numeral: VVVIV}
00109 \textcolor{stringliteral}{}
00110 \textcolor{stringliteral}{    >>> roman\_to\_int(1)}
00111 \textcolor{stringliteral}{    Traceback (most recent call last):}
00112 \textcolor{stringliteral}{     ...}
00113 \textcolor{stringliteral}{    TypeError: expected string, got <type 'int'>}
00114 \textcolor{stringliteral}{}
00115 \textcolor{stringliteral}{    >>> roman\_to\_int('a')}
00116 \textcolor{stringliteral}{    Traceback (most recent call last):}
00117 \textcolor{stringliteral}{     ...}
00118 \textcolor{stringliteral}{    ValueError: input is not a valid roman numeral: A}
00119 \textcolor{stringliteral}{}
00120 \textcolor{stringliteral}{    >>> roman\_to\_int('IL')}
00121 \textcolor{stringliteral}{    Traceback (most recent call last):}
00122 \textcolor{stringliteral}{     ...}
00123 \textcolor{stringliteral}{    ValueError: input is not a valid roman numeral: IL}
00124 \textcolor{stringliteral}{}
00125 \textcolor{stringliteral}{    """}   
00126     \textcolor{keywordflow}{if} type(input\_) != type(\textcolor{stringliteral}{""}):
00127         \textcolor{comment}{#raise TypeError, "expected string, got %s" % type(input\_)}
00128         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00129     input\_ = input\_.upper()
00130     nums = [\textcolor{stringliteral}{'M'}, \textcolor{stringliteral}{'D'}, \textcolor{stringliteral}{'C'}, \textcolor{stringliteral}{'L'}, \textcolor{stringliteral}{'X'}, \textcolor{stringliteral}{'V'}, \textcolor{stringliteral}{'I'}]
00131     ints = [1000, 500, 100, 50, 10, 5, 1]
00132     places = []
00133     \textcolor{keywordflow}{for} c \textcolor{keywordflow}{in} input\_:
00134         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} c \textcolor{keywordflow}{in} nums:
00135             \textcolor{comment}{#raise ValueError, "input is not a valid roman numeral: %s" % input\_}
00136             \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00137     \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} range(len(input\_)):
00138         c = input\_[i]
00139         value = ints[nums.index(c)]
00140         \textcolor{comment}{# If the next place holds a larger number, this value is negative.}
00141         \textcolor{keywordflow}{try}:
00142             nextvalue = ints[nums.index(input\_[i + 1])]
00143             \textcolor{keywordflow}{if} nextvalue > value:
00144                 value *= -1
00145         \textcolor{keywordflow}{except} IndexError:
00146             \textcolor{comment}{# there is no next place.}
00147             \textcolor{keywordflow}{pass}
00148         places.append(value)
00149     sum\_ = 0
00150     \textcolor{keywordflow}{for} n \textcolor{keywordflow}{in} places: sum\_ += n
00151     \textcolor{comment}{# Easiest test for validity...}
00152     \textcolor{keywordflow}{if} \hyperlink{namespacepyneb_1_1utils_1_1misc_a7a4c4b4ba1c884da72e0ea05aa8fb90b}{int\_to\_roman}(sum\_) == input\_:
00153         \textcolor{keywordflow}{return} sum\_
00154     \textcolor{keywordflow}{else}:
00155         \textcolor{comment}{#raise ValueError, 'input is not a valid roman numeral: %s' % input\_}
00156         \textcolor{keywordflow}{return} \textcolor{keywordtype}{None}
00157       
00158       
\hypertarget{misc_8py_source_l00159}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a2bb6f906a75f26a882093e9ce9272507}{00159} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a2bb6f906a75f26a882093e9ce9272507}{parseAtom}(atom):
00160     \textcolor{stringliteral}{'''Parses an atom label into the element and spectrum parts'''}
00161 
00162     iso = \textcolor{stringliteral}{''}
00163     elem = \textcolor{stringliteral}{''}
00164     spec = \textcolor{stringliteral}{''}
00165     cont = \textcolor{keyword}{True}
00166     firstdigit = \textcolor{keyword}{True}
00167     \textcolor{keywordflow}{for} l \textcolor{keywordflow}{in} atom:
00168         \textcolor{keywordflow}{if} l.isalpha() \textcolor{keywordflow}{and} cont:
00169             elem += l
00170             firstdigit = \textcolor{keyword}{False}
00171         \textcolor{keywordflow}{elif} l.isdigit():
00172             \textcolor{keywordflow}{if} firstdigit:
00173                 iso += l
00174             \textcolor{keywordflow}{else}:
00175                 spec += l
00176                 cont = \textcolor{keyword}{False}
00177     \textcolor{keywordflow}{return} iso+str.capitalize(elem), spec
00178 
00179 
\hypertarget{misc_8py_source_l00180}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_aaf9c5249e3c3104e38854ca30f9df4b7}{00180} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_aaf9c5249e3c3104e38854ca30f9df4b7}{strExtract}(text, par1=None, par2=None): 
00181     \textcolor{stringliteral}{"""}
00182 \textcolor{stringliteral}{    Extract a substring from text (first parameter)}
00183 \textcolor{stringliteral}{     }
00184 \textcolor{stringliteral}{    If par1 is a string, the extraction starts after par1,}
00185 \textcolor{stringliteral}{    else if it is an integer, it starts at position par1.}
00186 \textcolor{stringliteral}{    If par 2 is a string, extraction stops at par2, }
00187 \textcolor{stringliteral}{    else if par2 is an integer, extraction stops after par2 characters.}
00188 \textcolor{stringliteral}{    }
00189 \textcolor{stringliteral}{    Examples: }
00190 \textcolor{stringliteral}{    }
00191 \textcolor{stringliteral}{    strExtract('test123','e','1')}
00192 \textcolor{stringliteral}{    strExtract('test123','st',4)}
00193 \textcolor{stringliteral}{    }
00194 \textcolor{stringliteral}{    """}
00195     \textcolor{keywordflow}{if} np.size(text) == 1:
00196         \textcolor{keywordflow}{if} type(par1) \textcolor{keywordflow}{is} int:
00197             str1 = text[par1::]
00198         \textcolor{keywordflow}{elif} type(par1) \textcolor{keywordflow}{is} str:
00199             str1 = text.split(par1)[-1]
00200         \textcolor{keywordflow}{else}:
00201             str1 = text
00202     
00203         \textcolor{keywordflow}{if} type(par2) \textcolor{keywordflow}{is} int:
00204             str2 = str1[0:par2]
00205         \textcolor{keywordflow}{elif} type(par2) \textcolor{keywordflow}{is} str:
00206             str2 = str1.split(par2)[0]
00207         \textcolor{keywordflow}{else}:
00208             str2 = str1
00209         \textcolor{keywordflow}{return} str2
00210     \textcolor{keywordflow}{else}:
00211         res = []
00212         \textcolor{keywordflow}{for} subtext \textcolor{keywordflow}{in} text:
00213             res1 = \hyperlink{namespacepyneb_1_1utils_1_1misc_aaf9c5249e3c3104e38854ca30f9df4b7}{strExtract}(subtext, par1=par1, par2=par2)
00214             \textcolor{keywordflow}{if} res1 != \textcolor{stringliteral}{''}:
00215                 res.append(res1)
00216         \textcolor{keywordflow}{return} res
00217 
00218 
\hypertarget{misc_8py_source_l00219}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ab2eb7efdb086136e683e7f05f17958a9}{00219} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ab2eb7efdb086136e683e7f05f17958a9}{formatExceptionInfo}(maxTBlevel=5):
00220     cla, exc, trbk = sys.exc\_info()
00221     excName = cla.\_\_name\_\_
00222     \textcolor{keywordflow}{try}:
00223         excArgs = exc.\_\_dict\_\_[\textcolor{stringliteral}{"args"}]
00224     \textcolor{keywordflow}{except} KeyError:
00225         excArgs = \textcolor{stringliteral}{"<no args>"}
00226     excTb = traceback.format\_tb(trbk, maxTBlevel)
00227     \textcolor{keywordflow}{return} (excName, excArgs, excTb)
00228 
\hypertarget{misc_8py_source_l00229}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_aa8d55231b0b2a1223bbd3acd3a1268e2}{00229} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_aa8d55231b0b2a1223bbd3acd3a1268e2}{multi\_split}(s, seps):
00230     res = [s]
00231     \textcolor{keywordflow}{for} sep \textcolor{keywordflow}{in} seps:
00232         s, res = res, []
00233         \textcolor{keywordflow}{for} seq \textcolor{keywordflow}{in} s:
00234             res += seq.split(sep)
00235     \textcolor{keywordflow}{return} res
00236 
00237 
\hypertarget{misc_8py_source_l00238}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a71fea98dc66e2a1793b5c86a345da052}{00238} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a71fea98dc66e2a1793b5c86a345da052}{cleanPypicFiles}(files=None, all\_=False, dir\_=None):
00239     \textcolor{stringliteral}{"""}
00240 \textcolor{stringliteral}{    Method to clean the directory containing the pypics files.}
00241 \textcolor{stringliteral}{}
00242 \textcolor{stringliteral}{    Parameters:}
00243 \textcolor{stringliteral}{        - files    list of files to be removed}
00244 \textcolor{stringliteral}{        - all\_      Boolean, is set to True, all the files are deleted from the directory}
00245 \textcolor{stringliteral}{        - dir\_      directory from where the files are removed. }
00246 \textcolor{stringliteral}{                If None (default), pn.config.pypic\_path is used.}
00247 \textcolor{stringliteral}{}
00248 \textcolor{stringliteral}{    """}
00249     \textcolor{keywordflow}{if} dir\_ \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00250         dir\_ = pn.config.pypic\_path
00251     \textcolor{keywordflow}{if} all\_:
00252         files = os.listdir(dir\_)
00253         \textcolor{keywordflow}{if} np.ndim(files) == 0:
00254             files = [files]
00255     \textcolor{keywordflow}{if} files \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00256         \textcolor{keywordflow}{return}
00257     \textcolor{keywordflow}{if} type(files) == type(\textcolor{stringliteral}{''}):
00258         files = [files]
00259     \textcolor{keywordflow}{for} file\_ \textcolor{keywordflow}{in} files:
00260         file\_path = os.path.join(dir\_, file\_)
00261         \textcolor{keywordflow}{try}:
00262             \textcolor{keywordflow}{if} os.path.isfile(file\_path):
00263                 os.remove(file\_path)
00264                 pn.log\_.message(\textcolor{stringliteral}{'Deleting \{0\}'}.format(file\_path), calling=\textcolor{stringliteral}{'cleanPypicFiles'})
00265         \textcolor{keywordflow}{except}:
00266             pn.log\_.warn(\textcolor{stringliteral}{'Unable to remove \{0\}'}.format(file\_path), calling=\textcolor{stringliteral}{'cleanPypicFiles'})
00267 
00268 
\hypertarget{misc_8py_source_l00269}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_aee812eafa08b828b4c65c700a6cf4ff6}{00269} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_aee812eafa08b828b4c65c700a6cf4ff6}{getPypicFiles}(dir\_=None):
00270     \textcolor{stringliteral}{"""}
00271 \textcolor{stringliteral}{    Return the list of files in the directory.}
00272 \textcolor{stringliteral}{}
00273 \textcolor{stringliteral}{    Parameters:}
00274 \textcolor{stringliteral}{        - dir\_     directory from where the files are removed. }
00275 \textcolor{stringliteral}{                   If None (default), pn.pypic\_path is used.}
00276 \textcolor{stringliteral}{}
00277 \textcolor{stringliteral}{    """}
00278     \textcolor{keywordflow}{if} dir\_ \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00279         dir\_ = pn.config.pypic\_path
00280     files = os.listdir(dir\_)
00281     \textcolor{keywordflow}{return} files
00282 
00283 
\hypertarget{misc_8py_source_l00284}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a1274ea579021bda5ae537337b7dacebd}{00284} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a1274ea579021bda5ae537337b7dacebd}{revert\_seterr}(oldsettings):
00285     \textcolor{stringliteral}{"""}
00286 \textcolor{stringliteral}{    This function revert the options of seterr to a value saved in oldsettings.}
00287 \textcolor{stringliteral}{    }
00288 \textcolor{stringliteral}{    Usage:}
00289 \textcolor{stringliteral}{        oldsettings = np.seterr(all='ignore')}
00290 \textcolor{stringliteral}{        to\_return = (result - int\_ratio) / int\_ratio # this will not issue Warning messages}
00291 \textcolor{stringliteral}{        revert\_seterr(oldsettings)}
00292 \textcolor{stringliteral}{}
00293 \textcolor{stringliteral}{    Parameters:}
00294 \textcolor{stringliteral}{        oldsettings  result of np.seterr(all='ignore')}
00295 \textcolor{stringliteral}{}
00296 \textcolor{stringliteral}{    """}
00297     np.seterr(over=oldsettings[\textcolor{stringliteral}{'over'}])
00298     np.seterr(divide=oldsettings[\textcolor{stringliteral}{'divide'}])
00299     np.seterr(invalid=oldsettings[\textcolor{stringliteral}{'invalid'}])
00300     np.seterr(under=oldsettings[\textcolor{stringliteral}{'under'}])
00301 
\hypertarget{misc_8py_source_l00302}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a852d66d22ba9e872484b3346dc28249e}{00302} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a852d66d22ba9e872484b3346dc28249e}{quiet\_divide}(a, b):
00303     \textcolor{stringliteral}{"""}
00304 \textcolor{stringliteral}{    This function returns the division of a by b, without any waring in case of b beeing 0.}
00305 \textcolor{stringliteral}{    """}
00306     oldsettings = np.seterr(all=\textcolor{stringliteral}{'ignore'})
00307     to\_return = a / b \textcolor{comment}{# this will not issue Warning messages}
00308     \hyperlink{namespacepyneb_1_1utils_1_1misc_a1274ea579021bda5ae537337b7dacebd}{revert\_seterr}(oldsettings)
00309     \textcolor{keywordflow}{return} to\_return
00310 
\hypertarget{misc_8py_source_l00311}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_a4ab5392913d261532484092f8856a39a}{00311} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_a4ab5392913d261532484092f8856a39a}{quiet\_log10}(a):
00312     \textcolor{stringliteral}{"""}
00313 \textcolor{stringliteral}{    This function returns the log10 of a, without any waring in case of b beeing 0.}
00314 \textcolor{stringliteral}{    """}
00315     oldsettings = np.seterr(all=\textcolor{stringliteral}{'ignore'})
00316     to\_return = np.log10(a) \textcolor{comment}{# this will not issue Warning messages}
00317     \hyperlink{namespacepyneb_1_1utils_1_1misc_a1274ea579021bda5ae537337b7dacebd}{revert\_seterr}(oldsettings)
00318     \textcolor{keywordflow}{return} to\_return
00319      
\hypertarget{misc_8py_source_l00320}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ae69de9c9e8f8bde114b8edd326f3b993}{00320} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ae69de9c9e8f8bde114b8edd326f3b993}{get\_reduced}(N\_rand, a, value\_method = 'original', error\_method='std'):
00321     \textcolor{stringliteral}{"""}
00322 \textcolor{stringliteral}{    This function returns a tuple of value and error corresponding to an array of values }
00323 \textcolor{stringliteral}{        obtained from a MonteCarlo computation}
00324 \textcolor{stringliteral}{    It takes as argument an array that contains the original value, }
00325 \textcolor{stringliteral}{        followed by N\_rand MonteCarlo values.}
00326 \textcolor{stringliteral}{    The relevant value is computed by returning the original value (default), the mean or the median, }
00327 \textcolor{stringliteral}{        depending on "value\_method"}
00328 \textcolor{stringliteral}{    The errors are computed by 68% quantiles or standart deviation (Default), }
00329 \textcolor{stringliteral}{        depending on "error\_method"}
00330 \textcolor{stringliteral}{    }
00331 \textcolor{stringliteral}{    """}
00332 
00333     \textcolor{keywordflow}{if} error\_method == \textcolor{stringliteral}{'quants'} \textcolor{keywordflow}{and} \textcolor{keywordflow}{not} pn.config.INSTALLED[\textcolor{stringliteral}{'scipy'}]:
00334         pn.log\_.error(\textcolor{stringliteral}{'Scipy not installed, use\_quants not available'}, calling = \textcolor{stringliteral}{'get\_reduced'})
00335     \textcolor{keywordflow}{else}:
00336         \textcolor{keyword}{from} scipy.stats.mstats \textcolor{keyword}{import} mquantiles
00337     
00338     
00339     \textcolor{keywordflow}{if} value\_method == \textcolor{stringliteral}{'original'}:
00340         value = a[0]
00341     \textcolor{keywordflow}{elif} value\_method == \textcolor{stringliteral}{'mean'}:
00342         value = a.mean()
00343     \textcolor{keywordflow}{elif} value\_method == \textcolor{stringliteral}{'median'}:
00344         value = np.median(a)
00345     
00346     \textcolor{keywordflow}{if} error\_method == \textcolor{stringliteral}{'quants'}:
00347         quants = mquantiles(a, [0.16, 0.84])
00348         error = (quants[1]-quants[0])/2.
00349     \textcolor{keywordflow}{elif} error\_method == \textcolor{stringliteral}{'uquants'}:
00350         quants = mquantiles(a, [0.16, 0.84])
00351         error = quants[1] - value
00352     \textcolor{keywordflow}{elif} error\_method == \textcolor{stringliteral}{'lquants'}:
00353         quants = mquantiles(a, [0.16, 0.84])
00354         error = value - quants[0]
00355         \textcolor{comment}{# error = (quants[1]-quants[0])/2)}
00356     \textcolor{keywordflow}{elif} error\_method == \textcolor{stringliteral}{'upper'}:
00357         mask = (a - value) >= 0
00358         error =  ((((a[mask] - value)**2).sum())/np.float(mask.sum()))**0.5
00359     \textcolor{keywordflow}{elif} error\_method == \textcolor{stringliteral}{'lower'}:
00360         mask = (a - value) <= 0
00361         error = -((((a[mask] - value)**2).sum())/np.float(mask.sum()))**0.5
00362     \textcolor{keywordflow}{elif} error\_method == \textcolor{stringliteral}{'std'}:
00363         error = a.std()
00364     \textcolor{keywordflow}{else}:
00365         pn.log\_.error(\textcolor{stringliteral}{'Unknown error method \{\}'}.format(error\_method))
00366         
00367     \textcolor{keywordflow}{return} (value, error)
00368     
00369 \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ad6fc4e32ea4c076ac81e99b5c1e74f13}{get\_reduced\_dic}(N\_rand, n\_obs\_ori, dic, value\_method = 'original', 
\hypertarget{misc_8py_source_l00370}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ad6fc4e32ea4c076ac81e99b5c1e74f13}{00370}                     error\_method=\textcolor{stringliteral}{'std'}, abund12 = \textcolor{keyword}{False}):
00371     \textcolor{stringliteral}{"""}
00372 \textcolor{stringliteral}{    This function returns a dictionary of values (ionic or atomic abundances, temp...) and errors.}
00373 \textcolor{stringliteral}{    It takes as argument a dictionary that is supposed to contains n\_obs\_ori values from}
00374 \textcolor{stringliteral}{        the original observations, followed (optionaly) by N\_rand*n\_obs\_ori MonteCarlo values.}
00375 \textcolor{stringliteral}{    The new values are computed by returning the original value (default), the mean or the median, }
00376 \textcolor{stringliteral}{        depending on "value\_method"}
00377 \textcolor{stringliteral}{    The errors are computed by 68% quantiles or standart deviation (Default), depending on on "error\_method
      "}
00378 \textcolor{stringliteral}{    }
00379 \textcolor{stringliteral}{    It also transforms the abundances by number into 12+log10(abundances by number)}
00380 \textcolor{stringliteral}{    """}
00381     res = \{\}
00382     \textcolor{keywordflow}{for} key \textcolor{keywordflow}{in} dic:
00383         value = []
00384         error = []
00385         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} np.arange(n\_obs\_ori):
00386             \textcolor{keywordflow}{if} abund12:
00387                 values = 12 + np.log10(dic[key][n\_obs\_ori+i*N\_rand:n\_obs\_ori+(i+1)*N\_rand])
00388                 values = np.insert(values, 0, 12 + np.log10(dic[key][i]))
00389             \textcolor{keywordflow}{else}:
00390                 values = dic[key][n\_obs\_ori+i*N\_rand:n\_obs\_ori+(i+1)*N\_rand]
00391                 values = np.insert(values, 0, dic[key][i])
00392             tt = np.isfinite(values)
00393             \textcolor{keywordflow}{if} tt.sum() == 0:
00394                 value.append(np.NAN)
00395                 error.append(0.0)
00396             \textcolor{keywordflow}{else}:
00397                 v, e = \hyperlink{namespacepyneb_1_1utils_1_1misc_ae69de9c9e8f8bde114b8edd326f3b993}{get\_reduced}(N\_rand, values[tt], value\_method = value\_method, 
00398                                    error\_method=error\_method)
00399                 value.append(v)
00400                 error.append(e)
00401         res[key] = np.array(value)
00402         res[\textcolor{stringliteral}{'\{0\}\_e'}.format(key)] = np.array(error)
00403     \textcolor{keywordflow}{return} res
00404 
\hypertarget{misc_8py_source_l00405}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_af39dcb3c2627e5f29063e47ca4327f94}{00405} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_af39dcb3c2627e5f29063e47ca4327f94}{addRand}(N, list\_, list\_errors=None, lowlim=None):
00406     \textcolor{stringliteral}{"""}
00407 \textcolor{stringliteral}{    This function adds MonteCarlo random-gauss values to a list.}
00408 \textcolor{stringliteral}{    }
00409 \textcolor{stringliteral}{    Parameters:}
00410 \textcolor{stringliteral}{        N: number of MonteCarlo values to be added}
00411 \textcolor{stringliteral}{        list\_: list of input values}
00412 \textcolor{stringliteral}{        list\_errors: list of errors associated to the values in list\_. The errors are absolutes, the }
00413 \textcolor{stringliteral}{            result will be a gaussian distribution of sigma=list\_errors.}
00414 \textcolor{stringliteral}{            If None, the functions adds N time the same values to the list}
00415 \textcolor{stringliteral}{        lowlim: if not None (default), any random-gauss number lower then the lowlim value is set to
       lowlim.}
00416 \textcolor{stringliteral}{        }
00417 \textcolor{stringliteral}{    Usage:}
00418 \textcolor{stringliteral}{        print addRand(3, [1,2,3]) # no errors: no random values, only replicates the values}
00419 \textcolor{stringliteral}{            [1, 2, 3, 1, 1, 1, 2, 2, 2, 3, 3, 3]}
00420 \textcolor{stringliteral}{        print addRand(3, [1,20,300], [1, 1, 0.1])}
00421 \textcolor{stringliteral}{            [1, 20, 300, }
00422 \textcolor{stringliteral}{            1.550094377016822, 1.868307356917796, 1.0242090163674675, }
00423 \textcolor{stringliteral}{            19.782857703031276, 19.049474190752157, 21.58680361755194, }
00424 \textcolor{stringliteral}{            299.99810384362934, 300.00753905080154, 299.94052054137694]}
00425 \textcolor{stringliteral}{    """}
00426     
00427     \textcolor{comment}{# Check that the 2nd argument is a list}
00428     \textcolor{keywordflow}{if} type(list\_) != type([]):
00429         pn.log\_.error(\textcolor{stringliteral}{'The second argument must be a list'}, calling = \textcolor{stringliteral}{'addRand'})
00430     new\_list = list\_[:]
00431     \textcolor{comment}{# Computes the new values}
00432     \textcolor{keywordflow}{if} N != 0:
00433         \textcolor{comment}{# initialize the new list with the values of list\_}
00434         to\_extend = []
00435         \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} xrange(len(list\_)):
00436             \textcolor{keywordflow}{if} list\_errors \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00437                 to\_extend.extend([list\_[i]] * N)
00438             \textcolor{keywordflow}{else}:
00439                 to\_extend.extend(np.random.standard\_normal(N) * list\_errors[i] + list\_[i])
00440         \textcolor{comment}{# filter the values lower than lowlim}
00441         \textcolor{keywordflow}{if} lowlim \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
00442             to\_extend = [value \textcolor{keywordflow}{if} value > lowlim \textcolor{keywordflow}{else} lowlim \textcolor{keywordflow}{for} value \textcolor{keywordflow}{in} to\_extend]
00443         new\_list.extend(to\_extend)
00444     \textcolor{keywordflow}{return} new\_list
00445 
00446 \textcolor{stringliteral}{"""}
00447 \textcolor{stringliteral}{def solve\_r(a, b):}
00448 \textcolor{stringliteral}{    if rpy\_ok:}
00449 \textcolor{stringliteral}{        return base.solve(a, b)}
00450 \textcolor{stringliteral}{    else:}
00451 \textcolor{stringliteral}{        return None}
00452 \textcolor{stringliteral}{    }
00453 \textcolor{stringliteral}{def solve\_lapack(a, b):}
00454 \textcolor{stringliteral}{    from numpy.linalg import lapack\_lite}
00455 \textcolor{stringliteral}{}
00456 \textcolor{stringliteral}{    n\_eq = a.shape[0]}
00457 \textcolor{stringliteral}{    n\_rhs = b.shape[0]}
00458 \textcolor{stringliteral}{}
00459 \textcolor{stringliteral}{    pivots = np.zeros(n\_eq, np.intc)}
00460 \textcolor{stringliteral}{    results = lapack\_lite.dgesv(n\_eq, n\_rhs, a, n\_eq, pivots, b, n\_eq, 0)}
00461 \textcolor{stringliteral}{    return results  }
00462 \textcolor{stringliteral}{"""}
00463 
00464 \textcolor{keywordflow}{if} cvxopt\_ok:
\hypertarget{misc_8py_source_l00465}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_ae2d7579afe060895b9d6ebc2f4d59d42}{00465}     \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_ae2d7579afe060895b9d6ebc2f4d59d42}{solve\_cvxopt}(a, b):
00466         A = cvxopt.matrix(a)
00467         B = cvxopt.matrix(b)
00468         \textcolor{keywordflow}{return} cvxopt.lapack.gesv(A, B)    
00469     
00470 \textcolor{stringliteral}{"""}
00471 \textcolor{stringliteral}{# @profile}
00472 \textcolor{stringliteral}{if cvxopt\_ok:}
00473 \textcolor{stringliteral}{    @profile}
00474 \textcolor{stringliteral}{    def solve(a, b):}
00475 \textcolor{stringliteral}{        return solve\_cvxopt(a, b)}
00476 \textcolor{stringliteral}{else:}
00477 \textcolor{stringliteral}{    @profile}
00478 \textcolor{stringliteral}{    def solve(a, b):}
00479 \textcolor{stringliteral}{        return solve\_np(a,b)}
00480 \textcolor{stringliteral}{"""}
00481 \textcolor{comment}{#@profile}
\hypertarget{misc_8py_source_l00482}{}\hyperlink{namespacepyneb_1_1utils_1_1misc_aa5d9daf83958e9b6bd123954d495e94c}{00482} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1misc_aa5d9daf83958e9b6bd123954d495e94c}{solve}(a, b):
00483     \textcolor{keywordflow}{return} solve\_np(a,b)
00484 
\end{DoxyCode}
