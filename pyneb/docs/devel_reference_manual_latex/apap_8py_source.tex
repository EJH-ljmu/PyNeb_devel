\hypertarget{apap_8py}{\section{apap.\-py}
\label{apap_8py}\index{pyneb/utils/apap.\-py@{pyneb/utils/apap.\-py}}
}

\begin{DoxyCode}
\hypertarget{apap_8py_source_l00001}{}\hyperlink{namespacepyneb_1_1utils_1_1apap}{00001} \textcolor{keyword}{import} re
00002 \textcolor{keyword}{import} gzip
00003 \textcolor{keyword}{import} os
00004 \textcolor{keyword}{import} numpy \textcolor{keyword}{as} np
00005 \textcolor{keyword}{import} pyneb \textcolor{keyword}{as} pn
00006 \textcolor{keyword}{from} misc \textcolor{keyword}{import} int\_to\_roman 
00007 \textcolor{keyword}{from} physics \textcolor{keyword}{import} sym2name
00008 \textcolor{keyword}{from} manage\_atomic\_data \textcolor{keyword}{import} getLevelsNIST
00009 
\hypertarget{apap_8py_source_l00010}{}\hyperlink{namespacepyneb_1_1utils_1_1apap_aba49aa2681eafa29fc85cb550e4ce28a}{00010} term2\_dic = \{\textcolor{stringliteral}{'0'}:\textcolor{stringliteral}{'S'}, \textcolor{stringliteral}{'1'}:\textcolor{stringliteral}{'P'}, \textcolor{stringliteral}{'2'}:\textcolor{stringliteral}{'D'}, \textcolor{stringliteral}{'3'}:\textcolor{stringliteral}{'F'}, \textcolor{stringliteral}{'4'}:\textcolor{stringliteral}{'G'}, \textcolor{stringliteral}{'5'}:\textcolor{stringliteral}{'H'}, \textcolor{stringliteral}{'6'}:\textcolor{stringliteral}{'I'}\}
00011 
\hypertarget{apap_8py_source_l00012}{}\hyperlink{namespacepyneb_1_1utils_1_1apap_ac3d6e43ef2ad84632e9b5a101e115cb1}{00012} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1apap_ac3d6e43ef2ad84632e9b5a101e115cb1}{conv\_apap}(str\_in):
00013     \textcolor{stringliteral}{"""}
00014 \textcolor{stringliteral}{    transform "1.3-01" into 1.3e-01 }
00015 \textcolor{stringliteral}{    """}
00016     a, b = re.split(\textcolor{stringliteral}{'\(\backslash\)+|-'},str\_in)
00017     \textcolor{keywordflow}{if} \textcolor{stringliteral}{'-'} \textcolor{keywordflow}{in} str\_in:
00018         \textcolor{keywordflow}{return} float(a) / 10**float(b)
00019     \textcolor{keywordflow}{else}:
00020         \textcolor{keywordflow}{return} float(a) * 10**float(b)
00021 
\hypertarget{apap_8py_source_l00022}{}\hyperlink{namespacepyneb_1_1utils_1_1apap_ad24a246526c0913b752319c5a2846412}{00022} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1apap_ad24a246526c0913b752319c5a2846412}{read\_apap}(apap\_file, max\_levels=10):
00023     \textcolor{keywordflow}{if} max\_levels \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00024         max\_levels = np.Inf
00025         
00026     term1 = []
00027     term2 = []
00028     energy = []
00029     J = []
00030     \textcolor{keywordflow}{if} apap\_file.split(\textcolor{stringliteral}{'.'})[-1] == \textcolor{stringliteral}{'gz'}:
00031         f = gzip.open(apap\_file)
00032     \textcolor{keywordflow}{else}:
00033         f = open(apap\_file)
00034     foo = f.readline()
00035     \textcolor{keywordflow}{while} \textcolor{keyword}{True}:
00036         line = f.readline()
00037         \textcolor{keywordflow}{if} line[0:5] == \textcolor{stringliteral}{"   -1"}:
00038             \textcolor{keywordflow}{break}
00039         lev = int(line[0:5])
00040         \textcolor{keywordflow}{if} lev <= max\_levels:
00041             term1.append(line[25:26])
00042             term2.append(line[27:28])
00043             J.append(line[29:33])
00044             energy.append(line[34::])
00045     term = [t1+term2\_dic[t2] \textcolor{keywordflow}{for} t1,t2 \textcolor{keywordflow}{in} zip(term1, term2)]
00046     
00047     lev\_i = []
00048     lev\_j = []
00049     As = []
00050     Omegas = []
00051     
00052     temps\_str = f.readline().split()[2::]
00053     temp\_array = np.array([\hyperlink{namespacepyneb_1_1utils_1_1apap_ac3d6e43ef2ad84632e9b5a101e115cb1}{conv\_apap}(temp) \textcolor{keywordflow}{for} temp \textcolor{keywordflow}{in} temps\_str])
00054     N\_temp = len(temp\_array)
00055     \textcolor{keywordflow}{while} \textcolor{keyword}{True}:
00056         line = f.readline()
00057         \textcolor{keywordflow}{if} line[0:4] == \textcolor{stringliteral}{"  -1"}:
00058             \textcolor{keywordflow}{break}
00059         i = int(line[1:4])
00060         j = int(line[4:8])
00061         \textcolor{keywordflow}{if} (i <= max\_levels) \textcolor{keywordflow}{and} (j <= max\_levels):
00062             lev\_i.append(i)
00063             lev\_j.append(j)
00064             strg5 = line[8:8+(N\_temp+1)*8].split()
00065             As.append(\hyperlink{namespacepyneb_1_1utils_1_1apap_ac3d6e43ef2ad84632e9b5a101e115cb1}{conv\_apap}(strg5[0]))
00066             Omegas.append([\hyperlink{namespacepyneb_1_1utils_1_1apap_ac3d6e43ef2ad84632e9b5a101e115cb1}{conv\_apap}(omega) \textcolor{keywordflow}{for} omega \textcolor{keywordflow}{in} strg5[1::]])
00067     f.close()
00068     
00069     return(term, 
00070            np.array(energy, dtype=\textcolor{stringliteral}{'float'}), 
00071            np.array(J, dtype=\textcolor{stringliteral}{'float'}), 
00072            np.array(lev\_i, dtype=\textcolor{stringliteral}{'int'}), 
00073            np.array(lev\_j, dtype=\textcolor{stringliteral}{'int'}), 
00074            np.array(As, dtype=\textcolor{stringliteral}{'float'}), 
00075            np.array(Omegas, dtype=\textcolor{stringliteral}{'float'}), 
00076            temp\_array)
00077 
\hypertarget{apap_8py_source_l00078}{}\hyperlink{namespacepyneb_1_1utils_1_1apap_a4fccb2b8771d515b0be6f8a1921c0c58}{00078} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1apap_a4fccb2b8771d515b0be6f8a1921c0c58}{apap2ascii}(apap\_file, max\_levels=10, source='http://www.apap-network.org/\textcolor{stringliteral}{'):}
00079 \textcolor{stringliteral}{    }
00080 \textcolor{stringliteral}{    atom = apap\_file.split(}\textcolor{stringliteral}{'#'})[1].split(\textcolor{stringliteral}{'.'})[0]
00081     spectrum = int(re.findall(\textcolor{stringliteral}{r'\(\backslash\)d+'}, atom)[0]) + 1
00082     ioniz = \hyperlink{namespacepyneb_1_1utils_1_1misc_a7a4c4b4ba1c884da72e0ea05aa8fb90b}{int\_to\_roman}(spectrum).lower()
00083     elem = re.findall(\textcolor{stringliteral}{'[a-zA-Z]+'}, atom)[0]
00084     ion\_str = \textcolor{stringliteral}{'\{0\}\{1\}'}.format(elem.capitalize(), spectrum)
00085     print(\textcolor{stringliteral}{'Reading NIST data for \{0\}'}.format(ion\_str))
00086     NIST\_levels = \hyperlink{namespacepyneb_1_1utils_1_1manage__atomic__data_ad09376e8676854d44680ae14210b5589}{getLevelsNIST}(ion\_str)
00087     NIST\_full\_term = [\textcolor{stringliteral}{'\{0:2s\}\{1:.1f\}'}.format(l[\textcolor{stringliteral}{'term'}][0:2],float(l[\textcolor{stringliteral}{'J'}])) \textcolor{keywordflow}{for} l \textcolor{keywordflow}{in}  NIST\_levels]
00088     
00089     term, energy, J, lev\_i, lev\_j, As, Omegas, temp\_array = \hyperlink{namespacepyneb_1_1utils_1_1apap_ad24a246526c0913b752319c5a2846412}{read\_apap}(apap\_file, max\_levels=
      max\_levels)
00090     N\_temp = len(temp\_array)
00091 
00092     APAP\_full\_term = [\textcolor{stringliteral}{'\{0:2s\}\{1:.1f\}'}.format(t,float(j)) \textcolor{keywordflow}{for} t, j \textcolor{keywordflow}{in} zip(term, J)]
00093     
00094     N\_levels = len(energy)
00095     stat\_weight = J * 2 + 1
00096         
00097     Omega3d = np.zeros((N\_levels, N\_levels, N\_temp))
00098     \textcolor{keywordflow}{for} i, j, Omega \textcolor{keywordflow}{in} zip(lev\_i, lev\_j, Omegas):
00099         \textcolor{keywordflow}{try}:
00100             i\_NIST = NIST\_full\_term.index(APAP\_full\_term[i-1])
00101         \textcolor{keywordflow}{except}:
00102             i\_NIST = \textcolor{keywordtype}{None}
00103         \textcolor{keywordflow}{try}:
00104             j\_NIST = NIST\_full\_term.index(APAP\_full\_term[j-1])
00105         \textcolor{keywordflow}{except}:
00106             j\_NIST = \textcolor{keywordtype}{None}
00107         \textcolor{keywordflow}{if} (i\_NIST \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}) \textcolor{keywordflow}{and} (j\_NIST \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}):
00108             Omega3d[i\_NIST, j\_NIST] = Omega
00109         \textcolor{keywordflow}{else}:
00110             pn.log\_.warn(\textcolor{stringliteral}{'Levels not found in NIST: \{0\} \{1\}'}.format(APAP\_full\_term[i-1], 
00111                                                                     APAP\_full\_term[j-1]))
00112             
00113     f\_coll = open(\textcolor{stringliteral}{'\{0\}\_\{1\}\_coll\_APAP14.dat'}.format(elem, ioniz),\textcolor{stringliteral}{'w'})
00114     str\_ = \textcolor{stringliteral}{'0   0 '}
00115     str\_ += \textcolor{stringliteral}{''}.join(\textcolor{stringliteral}{' \{0:10.4e\}'}.format(T) \textcolor{keywordflow}{for} T \textcolor{keywordflow}{in} temp\_array)
00116     str\_ += \textcolor{stringliteral}{'\(\backslash\)n'}
00117     f\_coll.write(str\_)
00118     \textcolor{keywordflow}{for} i \textcolor{keywordflow}{in} 1+np.arange(N\_levels):
00119         \textcolor{keywordflow}{for} j \textcolor{keywordflow}{in} i+1+np.arange(N\_levels-i):
00120             str\_ = \textcolor{stringliteral}{'\{0\} \{1\} '}.format(i, j)
00121             str\_ += \textcolor{stringliteral}{''}.join(\textcolor{stringliteral}{' \{0:10.8e\}'}.format(O) \textcolor{keywordflow}{for} O \textcolor{keywordflow}{in} Omega3d[j-1, i-1])
00122             str\_ += \textcolor{stringliteral}{'\(\backslash\)n'}
00123             f\_coll.write(str\_)
00124     \textcolor{keywordflow}{try}:
00125         f\_coll.write(\textcolor{stringliteral}{"*** ATOM \{0\}\(\backslash\)n"}.format(sym2name[elem.capitalize()]))
00126     \textcolor{keywordflow}{except}:
00127         pn.log\_.warn(\textcolor{stringliteral}{'No full name for element \{0\}'}.format(elem.capitalize()))
00128 
00129     f\_coll.write(\textcolor{stringliteral}{"""*** SPECTRUM \{0\}}
00130 \textcolor{stringliteral}{*** N\_LEVELS \{1\}}
00131 \textcolor{stringliteral}{*** T\_UNIT 'K'}
00132 \textcolor{stringliteral}{*** NOTE1 'Collision strengths'}
00133 \textcolor{stringliteral}{*** SOURCE1 '\{2\}'}
00134 \textcolor{stringliteral}{"""}.format(spectrum, N\_levels, source))
00135     
00136     f\_coll.close()
00137 
00138 
\hypertarget{apap_8py_source_l00139}{}\hyperlink{namespacepyneb_1_1utils_1_1apap_ac957f753a8fc1c667044b4324868753e}{00139} \textcolor{keyword}{def }\hyperlink{namespacepyneb_1_1utils_1_1apap_ac957f753a8fc1c667044b4324868753e}{make\_all}(dir\_ = '.', max\_levels=8):
00140     file\_liste = os.listdir(\textcolor{stringliteral}{'.'})
00141     \textcolor{keywordflow}{for} file\_ \textcolor{keywordflow}{in} file\_liste:
00142         \textcolor{keywordflow}{if} file\_[-1] == \textcolor{stringliteral}{'z'}:
00143             atom = file\_.split(\textcolor{stringliteral}{'#'})[1].split(\textcolor{stringliteral}{'.'})[0]
00144             \textcolor{keywordflow}{if} atom == \textcolor{stringliteral}{'fe'}:
00145                 \hyperlink{namespacepyneb_1_1utils_1_1apap_a4fccb2b8771d515b0be6f8a1921c0c58}{apap2ascii}(file\_, 34)
00146             \textcolor{keywordflow}{else}:
00147                 \hyperlink{namespacepyneb_1_1utils_1_1apap_a4fccb2b8771d515b0be6f8a1921c0c58}{apap2ascii}(file\_, max\_levels)
00148             print(\textcolor{stringliteral}{'\{0\} done'}.format(file\_))
\end{DoxyCode}
